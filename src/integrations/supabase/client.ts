
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://wllhsxoabzdzulomizzx.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsbGhzeG9hYnpkenVsb21penp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAzNjcxMTQsImV4cCI6MjA1NTk0MzExNH0.grR0m4oXBigY-o9dsvdw6l4zy2DPoneSzWyvhQSZsWY";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

// Function to store Amazon Ads tokens received directly
export const storeAmazonAdsTokens = async (credentials: {
  advertiserId: string;
  profileId: string;
  accessToken: string;
  refreshToken: string;
  expiresIn?: number;
}) => {
  try {
    // First, get the platform_id for Amazon
    const { data: platformData, error: platformError } = await supabase
      .from('ad_platforms')
      .select('id')
      .eq('name', 'amazon')
      .single();
    
    if (platformError || !platformData) {
      throw new Error(`Failed to find Amazon platform: ${platformError?.message}`);
    }
    
    // Calculate token expiration time
    const expiresInSeconds = credentials.expiresIn || 3600;
    const tokenExpiresAt = new Date();
    tokenExpiresAt.setSeconds(tokenExpiresAt.getSeconds() + expiresInSeconds);
    
    // Store or update credentials
    const { error: credentialError } = await supabase
      .from('platform_credentials')
      .upsert({
        advertiser_id: credentials.advertiserId,
        platform_id: platformData.id,
        profile_id: credentials.profileId,
        refresh_token: credentials.refreshToken,
        access_token: credentials.accessToken,
        token_expires_at: tokenExpiresAt.toISOString(),
        is_active: true,
        updated_at: new Date().toISOString()
      }, {
        onConflict: 'advertiser_id,platform_id'
      });
    
    if (credentialError) {
      throw new Error(`Failed to store credentials: ${credentialError.message}`);
    }
    
    // Log successful connection
    await supabase.from("token_refresh_logs").insert({
      advertiser_id: credentials.advertiserId,
      platform_id: platformData.id,
      operation_type: "manual_token_insert",
      status: "success",
    });
    
    return { success: true };
  } catch (error) {
    console.error('Error storing Amazon Ads tokens:', error);
    return { 
      success: false, 
      error: error instanceof Error ? error.message : 'Unknown error'
    };
  }
};
